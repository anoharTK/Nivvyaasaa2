<script>
  // ---------- Background video loader + robust mobile toggle ----------
  (function(){
    const video = document.getElementById('heroBgVideo');
    const hero = document.getElementById('heroSection');
    const mobileToggle = document.getElementById('mobileToggle');
    const mobileIcon = document.getElementById('mobileToggleIcon');
    const mobileText = document.getElementById('mobileToggleText');

    if (!video || !hero || !mobileToggle) {
      console.warn('Background video or mobile toggle not found.');
      return;
    }

    // Filenames (adjust if needed)
    const DESKTOP_SRC = 'Nivvyaasaa.mp4';
    const MOBILE_SRC  = 'Nivvyaasaa-mobile.mp4';

    const isMobileQuery = () => window.matchMedia('(max-width:767px)').matches;

    // load desktop source and attempt autoplay
    function loadForDesktop() {
      while (video.firstChild) video.removeChild(video.firstChild);
      const s = document.createElement('source');
      s.src = DESKTOP_SRC;
      s.type = 'video/mp4';
      video.appendChild(s);
      video.load();
      video.muted = true;
      video.play().catch((err) => {
        console.warn('Desktop autoplay blocked:', err);
        video.style.display = 'none';
        hero.style.backgroundImage = "url('images/hero-poster.jpg')";
        hero.style.backgroundSize = 'cover';
        hero.style.backgroundPosition = 'center';
      });
    }

    // helper that tries to play and returns a promise
    async function tryPlayVideo() {
      try {
        await video.play();
        return true;
      } catch (err) {
        console.warn('video.play() rejected:', err);
        return false;
      }
    }

    // Mobile toggle logic: load mobile source on demand and play/pause
    function setupMobileToggle() {
      // initial state
      mobileToggle.setAttribute('aria-pressed', 'false');
      mobileIcon.className = 'fa fa-play';
      mobileText.textContent = 'Play video';

      // single-run guard to prevent double-fire from touch+click
      let fired = false;
      function handleUserToggle(ev) {
        // prevent double firing
        if (fired) {
          // ignore duplicates for a short window
          ev.preventDefault();
          return;
        }
        fired = true;
        setTimeout(()=> fired = false, 300);

        ev.preventDefault();
        const isPlaying = mobileToggle.getAttribute('aria-pressed') === 'true';

        if (!isPlaying) {
          // user wants to start playback â€” load source and play
          while (video.firstChild) video.removeChild(video.firstChild);
          const s = document.createElement('source');
          // prefer mobile file and fallback to desktop if missing; browser will 404 if file absent
          s.src = MOBILE_SRC;
          s.type = 'video/mp4';
          video.appendChild(s);
          video.load();

          video.muted = true; // important to allow play from user gesture
          // reveal the video (CSS toggles .video-playing -> shows video)
          hero.classList.add('video-playing');

          // quick UI feedback
          mobileToggle.setAttribute('aria-pressed', 'true');
          mobileIcon.className = 'fa fa-pause';
          mobileText.textContent = 'Pause video';

          // attempt play
          tryPlayVideo().then(success => {
            if (!success) {
              // fallback: hide video and revert UI
              hero.classList.remove('video-playing');
              while (video.firstChild) video.removeChild(video.firstChild);
              video.load();
              mobileToggle.setAttribute('aria-pressed', 'false');
              mobileIcon.className = 'fa fa-play';
              mobileText.textContent = 'Play video';
            } else {
              // ensure the video element is visible (some browsers need display style)
              video.style.display = 'block';
              console.log('Mobile video started');
            }
          });
        } else {
          // user wants to pause playback
          try { video.pause(); } catch(e){}
          hero.classList.remove('video-playing');

          // remove source to free memory
          while (video.firstChild) video.removeChild(video.firstChild);
          video.load();

          mobileToggle.setAttribute('aria-pressed', 'false');
          mobileIcon.className = 'fa fa-play';
          mobileText.textContent = 'Play video';
          console.log('Mobile video paused & unloaded');
        }
      }

      // Add multiple event listeners to be robust across devices:
      mobileToggle.addEventListener('click', handleUserToggle, { passive: false });
      mobileToggle.addEventListener('touchend', function(e){ handleUserToggle(e); }, { passive: false });
      mobileToggle.addEventListener('pointerup', function(e){ handleUserToggle(e); }, { passive: false });

      // keyboard accessibility
      mobileToggle.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          handleUserToggle(e);
        }
      });
    }

    // init based on screen size
    function init() {
      if (isMobileQuery()) {
        // mobile: keep video hidden until user taps toggle (CSS default hides it)
        video.style.display = 'none';
        setupMobileToggle();
      } else {
        // desktop: autoplay background
        if (mobileToggle) mobileToggle.style.display = 'none';
        loadForDesktop();
      }
    }

    init();

    // Re-evaluate when crossing breakpoints (debounced)
    let rt;
    window.addEventListener('resize', () => {
      clearTimeout(rt);
      rt = setTimeout(() => {
        try { video.pause(); } catch(e){}
        while (video.firstChild) video.removeChild(video.firstChild);
        video.load();
        hero.classList.remove('video-playing');
        init();
      }, 220);
    });

    // Pause when tab hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        try { video.pause(); } catch(e){}
      } else if (!isMobileQuery()) {
        video.play().catch(()=>{});
      }
    });

  })();
</script>
